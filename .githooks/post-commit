#!/bin/sh
# git-to-daily post-commit hook
# Automatically generates a daily log entry after each commit
#
# Trigger Event: Runs after every successful git commit
# Configuration: Auto-detects vault by checking:
#   1. Parent directories for .obsidian folder (project inside vault)
#   2. Sibling directories for .obsidian folder (project alongside vault)
#   3. GIT_TO_DAILY_VAULT environment variable (fallback)

# Get the repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Function to find vault by traversing up looking for .obsidian folder
find_vault_in_parents() {
    local dir="$1"
    while [ "$dir" != "/" ] && [ "$dir" != "" ]; do
        if [ -d "$dir/.obsidian" ]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

# Function to find vault in sibling directories
find_vault_in_siblings() {
    local parent_dir="$(dirname "$1")"
    for sibling in "$parent_dir"/*; do
        if [ -d "$sibling/.obsidian" ]; then
            echo "$sibling"
            return 0
        fi
    done
    return 1
}

# Try to auto-detect vault path
# 1. Check if project is inside a vault (parent directories)
VAULT_PATH=$(find_vault_in_parents "$REPO_ROOT")

# 2. Check sibling directories for a vault
if [ -z "$VAULT_PATH" ]; then
    VAULT_PATH=$(find_vault_in_siblings "$REPO_ROOT")
fi

# Fall back to environment variable if auto-detect fails
if [ -z "$VAULT_PATH" ]; then
    VAULT_PATH="$GIT_TO_DAILY_VAULT"
fi

# Exit silently if no vault found
if [ -z "$VAULT_PATH" ]; then
    exit 0
fi

# Get the project name from the repository root directory
PROJECT_NAME=$(basename "$REPO_ROOT")

# Find and run the git-to-daily executable
# Priority: 1) Global install, 2) Local node_modules, 3) Direct from dist
if command -v git-to-daily >/dev/null 2>&1; then
    git-to-daily generate --vault "$VAULT_PATH" --project "$PROJECT_NAME"
elif [ -f "$REPO_ROOT/node_modules/.bin/git-to-daily" ]; then
    "$REPO_ROOT/node_modules/.bin/git-to-daily" generate --vault "$VAULT_PATH" --project "$PROJECT_NAME"
else
    # Fallback: Run directly from git-to-daily dist if available in vault
    GIT_TO_DAILY_PATH="$VAULT_PATH/01-Projects/git-to-daily/dist/index.js"
    if [ -f "$GIT_TO_DAILY_PATH" ]; then
        node "$GIT_TO_DAILY_PATH" generate --vault "$VAULT_PATH" --project "$PROJECT_NAME"
    fi
fi

# Always exit 0 - never block commits due to daily log failures
exit 0
